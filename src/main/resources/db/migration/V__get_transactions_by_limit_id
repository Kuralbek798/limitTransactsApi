CREATE OR REPLACE FUNCTION get_transactions_by_limit_id(
    p_limit_id UUID
)
RETURNS TABLE (
    id UUID,
    sum_numeric NUMERIC,
    currency TEXT,
    datetime TIMESTAMP WITH TIME ZONE,
    account_from INT,
    account_to INT,
    expense_category TEXT,
    tr_date DATE
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        tr.*,
        date_trunc('day', tr.datetime) AS tr_date
    FROM
        transactions tr
    JOIN
        checked_on_limit ch ON tr.id = ch.transaction_id
    WHERE
        ch.limit_id = p_limit_id
        AND tr.expense_category IN ('product', 'service')
        AND ch.limit_exceeded = FALSE;  -- Используйте FALSE вместо 'false'
END;
$$ LANGUAGE plpgsql;
