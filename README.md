markdown

# Микросервис для обработки транзакций и управления валютными курсами

## Описание проекта

Этот микросервис предоставляет API для обработки транзакций и управления лимитами расходов. Он включает возможность интеграции с внешним API для получения актуальных курсов валют. Основные функции включают:
- Запись транзакций с проверкой на превышение месячного лимита.
- Установление нового лимита.
- Получение всех лимитов.
- Получение списка транзакций,превысивших лимит.

## Требования

- Docker
- Docker Compose

## Установка и запуск

### 1. Клонирование репозитория

```sh
git clone https://github.com/yourusername/yourrepo.git
cd yourrepo
2. Конфигурация

в приложении подключен swagger если у Вас возник не обходимость протестировать или произвести отладку вы можете воспользоватья им используя любой удобный для Вас браузер используя ссылку ниже.
http://localhost:8080/swagger-ui/index.html#/

Файлы конфигурации уже включены в репозиторий. Ознакомьтесь с src/main/resources/application.properties, чтобы при необходимости настроить параметры:

properties

# Пример содержания application.properties

server.port=8080

# Настройки базы данных
spring.datasource.url=jdbc:postgresql://db:5432/mydb
spring.datasource.username=user
spring.datasource.password=password
spring.jpa.hibernate.ddl-auto=update

# Параметры шедулера
scheduler.enabled=true
scheduler.cron=0 0 1 1 *
scheduler.maxAttempts=10
scheduler.retryInterval=2000
scheduler.expectedIntervalMinutes=44640

# API ключи для внешнего сервиса курсов валют
external.api.key=your_api_key # Замените your_api_key на ваш API ключ

# Другие параметры конфигурации
3. Запуск Docker
Убедитесь, что ваши Dockerfile и docker-compose.yml файлы настроены корректно.

Запустите следующие команды для сборки и запуска контейнеров:

sh

docker-compose build
docker-compose up
4. Доступ к сервису
API будут доступны по адресу: http://localhost:8080
5. Основные маршруты API

Запись транзакции:
POST /transactions/process - запись новой транзакции.

Установка нового лимита:
POST /limits/setNewLimit - установить новый лимит расходов.

Получение списка транзакций, превысивших лимит:
GET /limits/exceededTransactions - получение списка транзакций с превышением лимита.

Получение всех лимитов:
GET /limits/all

Разработка и тестирование
Запуск тестов
Для запуска тестов используйте Maven или другой выбранный вами инструмент сборки:

sh

mvn test
Публикация и документация
Код проекта опубликован на GitHub.
Пожалуйста, ознакомьтесь с дополнительной документацией внутри проекта для более детальной информации.
Контейнеризация и деплой
Этот микросервис подготовлен для контейнеризации с помощью Docker и Docker Compose. Инструкции выше демонстрируют, как развернуть его в локальной среде разработки.
 Для продакшн-развертывания могут потребоваться дополнительные настройки безопасности, мониторинга и логирования.

ИНСТРУКЦИЯ ДЛЯЯ АДМНИНИСТРОВАНИЯ ПЛАНИРОВЩИКА (Scheduler) в Spring Boot
данный планировщик обслуживает задачу по деактивации всех лимитов первого числа каждого месяца.
И установки нового базового лимита в размере 1000 usd.
так же шедуллер при запуске проверяет пропущенные задачи если были технические работы и приложение было не активно и задача пропущенна то при запуске шедуллер обнаружит это и выполнит пропущенное задание.(В дальнейшем можно реализовать управление шедуллером через контроллер например как активация и деактивация состояние можно хранить или в бд или локально в файле)

Управление через конфигурационный файл
1.1. Настройки планировщика Для управления поведением планировщика вам нужно внести изменения в файл конфигурации application.properties, который находится в директории src/main/resources/.
Доступные параметры scheduler.enabled: Указывает, включен ли планировщик. 
Значение: true - планировщик будет активен. Значение: false - планировщик будет отключен. scheduler.cron: Определяет расписание запуска задач в формате cron.
Пример: 
0 0 1 1 * — Запуск в 1:00 AM первого числа каждого месяца.
 0 0 * * * — Запуск каждый час.
 scheduler.maxAttempts: Указывает максимальное количество попыток выполнения задачи в случае неудачи.
Пример:
# Планировщик задач
scheduler.enabled = true
# Количество максимальных попыток запустить в случае если произошла ошибка при запуске
scheduler.maxAttempts=10
#Запуск в 1:00 AM первого числа каждого месяца.
scheduler.cron=0 0 1 1 * ?
 1.3. Применение изменений После внесения изменений в файл конфигурации необходимо перезапустить приложение, чтобы изменения вступили в силу.
2.3. Изменение расписания
Для изменения времени, в котором выполняется планировщик, вы можете обновить параметр scheduler.cron в файле application.properties. Например, чтобы запланировать задачу на выполнение каждый день в 3:00 PM, измените на:
properties
scheduler.cron=0 0 15 * * ? # Запуск каждый день в 3:00 PM
После изменения файла конфигурации не забудьте перезапустить приложение.
Запуск и задачи
3.	При запуске приложения:
o	Проверяется, были ли пропущены какие-либо задачи. Если да, они немедленно выполняются с соответствующей записью в логи.
4.	Выполнение задач по расписанию:
o	Задачи выполняются согласно cron-выражению. Если шедулер включен, задачи повторяются с заданным интервалом.
o	В случае успешного выполнения задачи записывается журнал с пометкой "SUCCESS". Если задача не удалась после нескольких попыток, журналируется "FAILED", и выбрасывается исключение ServiceException.
## Обработка ошибок

### 5. Логирование и ошибки
- Все события, включая пропущенные выполнения, успешные и неудачные попытки, записываются в логи.
- Исключения обрабатываются и логируются соответствующим образом, позволяя вам следить за выполнением задач и принимать необходимые меры в случае ошибки.

### 6. Ожидаемое поведение
- При запуске приложения происходит проверка на наличие пропущенных задач. Если такие задачи найдены, они немедленно обрабатываются.
- Планировщик будет выполнять задачи на основе заданного cron-расписания. Например, запланированная задача будет выполнена 1-го числа каждого месяца в 01:00, если шедулер включен.

### 7. Устранение неполадок
- Если после запуска не наблюдаются ожидаемые события: 
  - Просмотрите логи для выяснения причин неожиданного поведения.  

Эта инструкция должна помочь вам лучше управлять шедулером, а также эффективно использовать функции, предоставляемые вашим микросервисом. Если у вас возникнут дополнительные вопросы или вы столкнетесь с трудностями, обратитесь к документации или службе поддержки.
в миграции добавлены инсерты для мокоовых данных клиентов и их счетов.
Касательно выполненного задания то учитывая что пользователи устанавливающие лимиты это не известное множество то для определения наличия лимитов пользователей было принято решение использовать номера счетов так как в противном случае есть шанс выгрузить очень большое количество данных лимитов и сверять их с большим количеством данных транзакций.Так как пользователь является нашим клиентом то будем считать что у нас есть две доп таблицы пользователи и счета пользователей которые мы не можем менять но можем делать к ним sql запросы поэтому данные будем объединять через обычные join. Так же как вариант улучшения можно реализовать обработку данных сперва по базовому лимиту то есть паралельно с обработкой клиентских транзакций извлекаем данные из бд по базовому лимиту а потом на основе счетов получаем остальные лимиты и подтягиваем по ним данные с бд.